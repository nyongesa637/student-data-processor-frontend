<div class="app-shell">
  <mat-sidenav-container class="app-container">
    <mat-sidenav [opened]="sidenavOpen"
                 [mode]="isMobile ? 'over' : 'side'"
                 class="sidenav"
                 (closedStart)="sidenavOpen = false">
      <div class="sidenav-header">
        <mat-icon class="app-logo">school</mat-icon>
        <span class="app-title">SDP</span>
      </div>
      <div class="sidenav-nav">
        <mat-nav-list>
          <a mat-list-item *ngFor="let item of navItems"
             [routerLink]="item.path"
             routerLinkActive="active-link"
             [routerLinkActiveOptions]="{ exact: true }"
             class="nav-item">
            <mat-icon matListItemIcon>{{ item.icon }}</mat-icon>
            <span matListItemTitle>{{ item.label }}</span>
          </a>
        </mat-nav-list>
      </div>
      <div class="sidenav-footer">
        <mat-nav-list>
          <a mat-list-item
             [routerLink]="docsNavItem.path"
             routerLinkActive="active-link"
             [routerLinkActiveOptions]="{ exact: true }"
             class="nav-item">
            <mat-icon matListItemIcon>{{ docsNavItem.icon }}</mat-icon>
            <span matListItemTitle>{{ docsNavItem.label }}</span>
          </a>
        </mat-nav-list>
      </div>
    </mat-sidenav>

    <mat-sidenav-content class="main-content">
      <mat-toolbar class="header">
        <button mat-icon-button (click)="toggleSidenav()" class="menu-toggle">
          <mat-icon>{{ sidenavOpen ? 'view_sidebar' : 'view_sidebar' }}</mat-icon>
        </button>

        <nav class="breadcrumbs">
          <span *ngFor="let crumb of breadcrumbs; let last = last">
            <a *ngIf="!last" routerLink="/home" class="breadcrumb-link">{{ crumb }}</a>
            <span *ngIf="last" class="breadcrumb-current">{{ crumb }}</span>
            <mat-icon *ngIf="!last" class="breadcrumb-separator">chevron_right</mat-icon>
          </span>
        </nav>

        <div class="global-search">
          <div class="search-wrapper">
            <mat-icon>search</mat-icon>
            <input #searchInput
                   type="text"
                   placeholder="Search pages, actions, students..."
                   [(ngModel)]="searchQuery"
                   (input)="onSearchInput()"
                   (focus)="onSearchFocus()">
            <span class="search-shortcut" *ngIf="!isMobile">
              <span class="shortcut-key">Ctrl</span>
              <span class="shortcut-plus">+</span>
              <span class="shortcut-key">K</span>
            </span>
          </div>
          <div class="search-dropdown" *ngIf="showSearchDropdown">
            <ng-container *ngIf="searchResults.length > 0; else noResults">
              <div class="search-group" *ngFor="let group of ['Pages', 'Actions', 'Students']">
                <ng-container *ngIf="getGroupResults(group).length > 0">
                  <div class="group-label">{{ group }}</div>
                  <div class="search-item"
                       *ngFor="let result of getGroupResults(group)"
                       (mousedown)="onSearchResultClick(result)">
                    <mat-icon>{{ result.icon }}</mat-icon>
                    <span class="item-text">{{ result.text }}</span>
                    <span class="item-sub" *ngIf="result.sub">{{ result.sub }}</span>
                  </div>
                </ng-container>
              </div>
            </ng-container>
            <ng-template #noResults>
              <div class="no-results">No results for "{{ searchQuery }}"</div>
            </ng-template>
          </div>
        </div>

        <button mat-icon-button [matMenuTriggerFor]="notificationMenu" class="notification-btn">
          <mat-icon [matBadge]="unreadCount > 0 ? unreadCount : null" matBadgeColor="warn" matBadgeSize="small">
            notifications
          </mat-icon>
        </button>
        <mat-menu #notificationMenu="matMenu" class="notification-menu">
          <div class="notification-header" (click)="$event.stopPropagation()">
            <strong>Notifications</strong>
            <button mat-button color="primary" (click)="markAllRead()" *ngIf="unreadCount > 0">
              Mark all read
            </button>
          </div>
          <div *ngIf="notifications.length === 0" class="notification-empty" (click)="$event.stopPropagation()">
            No notifications yet
          </div>
          <button mat-menu-item *ngFor="let n of notifications" (click)="markRead(n)"
                  [class.unread]="!n.read" class="notification-item">
            <mat-icon>{{ getNotificationIcon(n.type) }}</mat-icon>
            <div class="notification-content">
              <span class="notification-message">{{ n.message }}</span>
              <span class="notification-time">{{ formatTime(n.createdAt) }}</span>
            </div>
          </button>
        </mat-menu>
      </mat-toolbar>

      <div class="page-content">
        <router-outlet></router-outlet>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Floating Chat -->
  <button mat-fab class="chat-fab" (click)="toggleChat()"
          [matBadge]="changelogCount > 0 ? changelogCount : null" matBadgeColor="warn" matBadgeSize="small">
    <mat-icon>{{ chatOpen ? 'close' : 'chat' }}</mat-icon>
  </button>

  <div class="chat-panel" *ngIf="chatOpen">
    <div class="chat-header">
      <h3>Help & Updates</h3>
    </div>
    <div class="chat-tabs">
      <button [class.active]="chatTab === 'changelog'" (click)="chatTab = 'changelog'">Changelog</button>
      <button [class.active]="chatTab === 'help'" (click)="chatTab = 'help'">Help</button>
    </div>
    <div class="chat-body">
      <!-- Changelog -->
      <ng-container *ngIf="chatTab === 'changelog'">
        <!-- Detail view -->
        <ng-container *ngIf="selectedChangelog; else changelogList">
          <div class="changelog-detail">
            <button class="changelog-back" (click)="selectedChangelog = null">
              <mat-icon>arrow_back</mat-icon>
              <span>Back</span>
            </button>
            <div class="changelog-detail-header">
              <div class="changelog-email-icon">
                <mat-icon>campaign</mat-icon>
              </div>
              <div class="changelog-email-meta">
                <span class="changelog-email-subject">{{ selectedChangelog.version }} Release</span>
                <span class="changelog-email-date">{{ formatChangelogDate(selectedChangelog.releaseDate) }}</span>
              </div>
            </div>
            <div class="changelog-detail-body">{{ selectedChangelog.changes }}</div>
            <div class="changelog-email-footer">
              <span class="changelog-email-tag">{{ selectedChangelog.component }}</span>
            </div>
          </div>
        </ng-container>
        <!-- List view -->
        <ng-template #changelogList>
          <div *ngIf="changelog.length === 0" class="no-results">No updates yet.</div>
          <div class="changelog-email" *ngFor="let entry of changelog" (click)="selectedChangelog = entry">
            <div class="changelog-email-header">
              <div class="changelog-email-icon">
                <mat-icon>campaign</mat-icon>
              </div>
              <div class="changelog-email-meta">
                <span class="changelog-email-subject">{{ entry.version }} Release</span>
                <span class="changelog-email-date">{{ formatChangelogDate(entry.releaseDate) }}</span>
              </div>
            </div>
            <div class="changelog-email-body">{{ entry.changes }}</div>
            <div class="changelog-email-footer">
              <span class="changelog-email-tag">{{ entry.component }}</span>
            </div>
          </div>
        </ng-template>
      </ng-container>

      <!-- Help as chat with / commands -->
      <ng-container *ngIf="chatTab === 'help'">
        <div class="chat-messages">
          <div *ngFor="let msg of chatMessages"
               class="chat-message"
               [class.user-message]="msg.type === 'user'"
               [class.system-message]="msg.type === 'system'">
            <div class="message-bubble">
              <span>{{ msg.text }}</span>
              <a *ngIf="msg.link" class="message-link" (click)="navigateFromChat(msg.link)">
                {{ msg.linkLabel }} <mat-icon>open_in_new</mat-icon>
              </a>
            </div>
          </div>
        </div>
        <div class="command-list" *ngIf="showCommandList">
          <div class="command-item" *ngFor="let cmd of helpCommands" (mousedown)="selectCommand(cmd.cmd)">
            <span class="cmd-name">{{ cmd.cmd }}</span>
            <span class="cmd-desc">{{ cmd.desc }}</span>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text"
                 [(ngModel)]="helpInput"
                 (input)="onHelpInput()"
                 (keydown)="onHelpKeydown($event)"
                 placeholder="Type / for commands...">
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Mobile Bottom Nav -->
  <nav class="bottom-nav" *ngIf="isMobile">
    <div class="bottom-nav-items">
      <a *ngFor="let item of navItems.slice(0, 5)"
         [routerLink]="item.path"
         routerLinkActive="active-link"
         [routerLinkActiveOptions]="{ exact: true }">
        <mat-icon>{{ item.icon }}</mat-icon>
        <span>{{ item.label }}</span>
      </a>
    </div>
  </nav>
</div>
